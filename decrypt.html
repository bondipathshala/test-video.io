
<!DOCTYPE html>
<html>
<head>
    <title>HLS Player</title>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player/dist/shaka-player.compiled.js"></script>
    <script>
        // JavaScript code starts here
        document.addEventListener('DOMContentLoaded', () => {
    const manifestUri = 'https://pub-4500d0da786d452db5b86ca12b54a6f4.r2.dev/output/manifest.m3u8'; // Replace with your HLS manifest URL
    const keyUrl = 'https://pub-4500d0da786d452db5b86ca12b54a6f4.r2.dev/output/enc.key';               // Replace with your key URL
    const ivUrl = 'https://pub-4500d0da786d452db5b86ca12b54a6f4.r2.dev/output/enc.iv';   


    shaka.polyfill.installAll(); // Install polyfills for older browsers

    if (!shaka.Player.isBrowserSupported()) {
        showError('This browser does not support the video format.');
        return;
    }

    const video = document.getElementById('video');
    const player = new shaka.Player(video);
    let errorContainer; // Initialize errorContainer variable

    // Optional: Set logging level
    if (shaka.log) {
        shaka.log.setLevel(shaka.log.Level.V2); // Detailed logging
    }

    // Register decryption response filter
    player.getNetworkingEngine().registerResponseFilter(async (type, response) => {
        if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
            try {
                const [key, iv] = await Promise.all([fetchKey(keyUrl), fetchIV(ivUrl)]);
                const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'AES-CTR' }, false, ['decrypt']);
                response.data = await crypto.subtle.decrypt({ name: 'AES-CTR', counter: iv, length: 64 }, cryptoKey, response.data);
            } catch (error) {
                showError(`Decryption Error: ${error.message}`);
                throw error; // Re-throw for Shaka Player error handling
            }
        }
    });

    // Load and play the video
    player.load(manifestUri)
        .then(() => console.log('Video loaded successfully!'))
        .catch(error => showError(`Error loading video: ${getShakaErrorMessage(error)}`));

    // Fetch key function (adjust for your authentication/storage method if needed)
    async function fetchKey(url) {
        const response = await fetch(url); // Or use your own fetching method
        if (!response.ok) {
            throw new Error(`Failed to fetch key from ${url}: ${response.status} ${response.statusText}`);
        }
        return await response.arrayBuffer();
    }

    // Fetch IV function (adjust if you use a different IV delivery mechanism)
    async function fetchIV(url) {
        const response = await fetch(url); // Or use your own fetching method
        if (!response.ok) {
            throw new Error(`Failed to fetch IV from ${url}: ${response.status} ${response.statusText}`);
        }
        const ivHex = await response.text();
        return new Uint8Array(ivHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
    }

    // Error handling function
    function showError(message) {
        console.error(message);
        errorContainer = document.getElementById('errorContainer'); // Get errorContainer inside the function
        if (errorContainer) {
            errorContainer.textContent = message;
            errorContainer.style.display = 'block'; // Show error message on screen
        } else {
            console.error("Error container element not found. Cannot display error message.");
        }
    }
   
    function getShakaErrorMessage(error) {
        if (error.code) {
            return `${error.code} - ${error.message}`;
        } else {
            return error.message || 'Unknown error';
        }
    }
});
        // JavaScript code ends here
    </script>
</head>
<body>
    <video id="video" width="640" height="360" controls></video>
    <div id="errorContainer" style="display: none; color: red;"></div> 
</body>
</html>
